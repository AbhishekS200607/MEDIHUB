<!DOCTYPE html>
<html>
<head>
  <title>MEDIHUB Debug</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #0f0; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #0f0; }
    button { background: #0f0; color: #000; padding: 10px 20px; margin: 5px; border: none; cursor: pointer; }
    pre { background: #000; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>üîß MEDIHUB Debug Console</h1>
  
  <div class="section">
    <h2>1. Authentication Status</h2>
    <div id="authStatus">Checking...</div>
  </div>

  <div class="section">
    <h2>2. User Profile</h2>
    <pre id="profileData">Loading...</pre>
  </div>

  <div class="section">
    <h2>3. Doctors List</h2>
    <pre id="doctorsData">Loading...</pre>
  </div>

  <div class="section">
    <h2>4. Test Appointment Booking</h2>
    <button id="bookBtn">Book Test Appointment</button>
    <pre id="bookingResult"></pre>
  </div>

  <div class="section">
    <h2>5. Firestore Real-time Listener</h2>
    <button id="startBtn">Start Listening to Appointments</button>
    <button id="stopBtn">Stop</button>
    <pre id="listenerData">Not started</pre>
  </div>

  <script type="module">
    import { auth } from './js/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { listenToQueue } from './js/appointments.js';

    let unsubscribe = null;
    let doctorsData = null;
    let userToken = null;

    console.log('Debug page loaded, waiting for auth...');

    onAuthStateChanged(auth, async (user) => {
      console.log('Auth state changed:', user);
      
      if (user) {
        try {
          document.getElementById('authStatus').innerHTML = `‚úÖ Logged in as: ${user.email}<br>UID: ${user.uid}`;
          
          // Get profile
          userToken = await user.getIdToken();
          console.log('Got token, fetching profile...');
          
          const profileRes = await fetch('/api/auth/profile', {
            headers: { 'Authorization': `Bearer ${userToken}` }
          });
          const profile = await profileRes.json();
          console.log('Profile:', profile);
          document.getElementById('profileData').textContent = JSON.stringify(profile, null, 2);

          // Get doctors
          console.log('Fetching doctors...');
          const doctorsRes = await fetch('/api/doctors');
          doctorsData = await doctorsRes.json();
          console.log('Doctors:', doctorsData);
          document.getElementById('doctorsData').textContent = JSON.stringify(doctorsData, null, 2);

          // Attach event listeners
          document.getElementById('bookBtn').addEventListener('click', async () => {
            const doctorId = doctorsData.doctors[0]?.id;
            if (!doctorId) {
              document.getElementById('bookingResult').textContent = 'No doctors found!';
              return;
            }

            const res = await fetch('/api/appointments/book', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${userToken}`
              },
              body: JSON.stringify({
                doctorId,
                time: '10:00',
                date: new Date().toISOString().split('T')[0]
              })
            });
            const result = await res.json();
            document.getElementById('bookingResult').textContent = JSON.stringify(result, null, 2);
          });

          document.getElementById('startBtn').addEventListener('click', () => {
            const doctorId = doctorsData.doctors[0]?.id || user.uid;
            document.getElementById('listenerData').textContent = `Listening to doctor: ${doctorId}...\n`;
            
            unsubscribe = listenToQueue(doctorId, (queue) => {
              document.getElementById('listenerData').textContent = 
                `üì° Real-time update received!\nQueue length: ${queue.length}\n\n` +
                JSON.stringify(queue, null, 2);
            });
          });

          document.getElementById('stopBtn').addEventListener('click', () => {
            if (unsubscribe) {
              unsubscribe();
              document.getElementById('listenerData').textContent = 'Listener stopped';
            }
          });
        } catch (error) {
          console.error('Error:', error);
          document.getElementById('authStatus').innerHTML = `‚ùå Error: ${error.message}`;
        }
      } else {
        document.getElementById('authStatus').innerHTML = '‚ùå Not logged in. <a href="/login" style="color: #0f0;">Login</a>';
      }
    });
  </script>
</body>
</html>
